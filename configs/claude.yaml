# Kapsis Configuration - Claude Code Agent
# Use with: ./scripts/launch-agent.sh ~/project --config configs/claude.yaml

agent:
  # Claude Code with spec file input
  command: "claude --dangerously-skip-permissions -p \"$(cat /task-spec.md)\""
  workdir: /workspace

filesystem:
  include:
    - ~/.claude
    - ~/.claude.json
    - ~/.gitconfig
    - ~/.ssh
    - ~/.zshrc

environment:
  # Retrieve API key from system keychain (macOS Keychain / Linux secret-tool)
  keychain:
    ANTHROPIC_API_KEY:
      service: "Claude Code-credentials"
  # Alternative: Use passthrough if you prefer to export ANTHROPIC_API_KEY manually
  # passthrough:
  #   - ANTHROPIC_API_KEY
  set:
    MAVEN_OPTS: "-Xmx4g -XX:+UseG1GC"

resources:
  memory: 8g
  cpus: 4

# Security hardening profile
# Profiles: minimal, standard (default), strict, paranoid
#
# Profile Comparison:
# ┌─────────────┬──────────────────────────────────────────────────────────────┐
# │ minimal     │ No security restrictions. Use only for debugging.            │
# │ standard    │ Drops dangerous capabilities, prevents privilege escalation. │
# │ strict      │ Adds syscall filtering, noexec /tmp, lower process limit.   │
# │ paranoid    │ Adds immutable /usr /bin, requires AppArmor/SELinux.        │
# └─────────────┴──────────────────────────────────────────────────────────────┘
#
# What each protection does:
#   • capabilities: Dropping them prevents raw network access, mounting, etc.
#   • no-new-privileges: Blocks setuid executables from gaining permissions.
#   • pids_limit: Max processes. Prevents fork bombs (1000 = plenty for builds).
#   • seccomp: Blocks dangerous syscalls (ptrace, mount, bpf) at kernel level.
#   • noexec_tmp: Prevents executing binaries written to /tmp.
#   • readonly_root: Makes /usr, /bin immutable (/workspace stays writable).
#
security:
  profile: standard

  # Enable seccomp filtering to block ptrace/mount/bpf syscalls
  # This adds kernel-level protection against container escape attempts
  seccomp:
    enabled: true

  # Keep higher PID limit for parallel builds (Maven, Gradle)
  process:
    pids_limit: 1000

  # ─────────────────────────────────────────────────────────────────────────
  # Configuration Examples:
  # ─────────────────────────────────────────────────────────────────────────
  #
  # Example 1: Maximum security for untrusted code/PRs
  # security:
  #   profile: strict
  #   filesystem:
  #     noexec_tmp: true
  #     readonly_root: true
  #
  # Example 2: Debugging mode (no restrictions)
  # security:
  #   profile: minimal
  #
  # Example 3: High-process workloads (large monorepos)
  # security:
  #   profile: standard
  #   seccomp:
  #     enabled: true
  #   process:
  #     pids_limit: 2000
  #
  # Example 4: Air-gapped security (requires LSM setup)
  # security:
  #   profile: paranoid
  #   lsm:
  #     required: true

maven:
  mirror_url: "https://artifactory.example.org/artifactory/releases"
  block_remote_snapshots: true
  block_deploy: true

git:
  auto_push:
    enabled: true
    remote: origin
    commit_message: |
      feat: {task}

      Generated by Claude Code via Kapsis
      Branch: {branch}

  # Co-authors added to every commit (Git trailer format)
  # Format: "Name <email>" - multiple co-authors supported
  co_authors:
    - "Aviad Shiber <aviadshiber@gmail.com>"

  # Files to exclude from commits (prevents accidental commits)
  # Default: .gitignore, .gitattributes (and nested variants)
  commit_exclude:
    - ".gitignore"
    - "**/.gitignore"

  # Fork-first workflow for contributing to external repos
  # When enabled, will fork the repo and push to fork if direct push fails
  fork_workflow:
    enabled: false
    # Fallback behavior when push fails: "fork" or "manual"
    fallback: fork
