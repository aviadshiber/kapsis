# Kapsis Network Allowlist Configuration
# ===============================================================================
# Default allowlist for DNS-based network filtering in filtered mode.
#
# Usage:
#   1. Use this file as-is for standard development workflows
#   2. Copy and modify for project-specific needs
#   3. Override via --config pointing to your custom config
#
# When network.mode is 'filtered', only domains listed here will resolve.
# All other domains return NXDOMAIN (DNS failure).
# ===============================================================================

network:
  # Network mode:
  #   none     - No network access (--network=none)
  #   filtered - DNS-based allowlist (this file defines what's allowed)
  #   open     - Unrestricted network access (not recommended)
  mode: filtered

  # DNS allowlist for filtered mode
  # Domains here will resolve; everything else is blocked
  allowlist:
    # Git hosting providers
    hosts:
      - github.com
      - "*.github.com"
      - gitlab.com
      - "*.gitlab.com"
      - bitbucket.org
      - "*.bitbucket.org"
      - dev.azure.com
      - ssh.dev.azure.com
      - "*.visualstudio.com"
      # Taboola internal
      - git.taboolasyndication.com

    # Package registries
    registries:
      # npm
      - registry.npmjs.org
      - npmjs.org
      - "*.npmjs.org"
      - registry.yarnpkg.com

      # Python
      - pypi.org
      - "*.pypi.org"
      - files.pythonhosted.org

      # Java/Maven
      - repo1.maven.org
      - repo.maven.apache.org
      - plugins.gradle.org
      - services.gradle.org
      - jcenter.bintray.com
      - dl.google.com
      - maven.google.com

      # Rust
      - crates.io
      - static.crates.io
      - index.crates.io

      # Go
      - proxy.golang.org
      - sum.golang.org
      - storage.googleapis.com

      # Ruby
      - rubygems.org

    # Container registries
    containers:
      - docker.io
      - "*.docker.io"
      - registry-1.docker.io
      - auth.docker.io
      - production.cloudflare.docker.com
      - gcr.io
      - "*.gcr.io"
      - ghcr.io
      - "*.ghcr.io"
      - quay.io
      - "*.quay.io"

    # AI API endpoints (for AI coding agents)
    # Only major providers included by default - add others to custom section
    ai:
      # Anthropic (Claude Code, Claude API)
      - api.anthropic.com
      - "*.anthropic.com"
      - claude.ai
      - "*.claude.ai"

      # OpenAI (Codex CLI, ChatGPT, GPT API)
      - api.openai.com
      - "*.openai.com"

      # Google (Gemini CLI, Vertex AI)
      - generativelanguage.googleapis.com
      - aiplatform.googleapis.com
      - gemini.google.com

      # Amazon (CodeWhisperer, Bedrock)
      - bedrock.amazonaws.com
      - "*.bedrock.amazonaws.com"
      - bedrock-runtime.amazonaws.com
      - codewhisperer.amazonaws.com

      # Microsoft (GitHub Copilot, Azure OpenAI)
      - api.githubcopilot.com
      - "*.githubcopilot.com"
      - openai.azure.com
      - "*.openai.azure.com"

      # Other AI providers (uncomment if needed):
      # - api.cohere.ai          # Cohere
      # - api.mistral.ai         # Mistral
      # - huggingface.co         # Hugging Face
      # - api.replicate.com      # Replicate
      # - api.together.xyz       # Together AI
      # - api.groq.com           # Groq
      # - api.perplexity.ai      # Perplexity

    # Custom/corporate hosts (add your internal registries here)
    custom:
      - artifactory.taboolasyndication.com
      - artifactory-build.taboolasyndication.com
      - ci.taboolasyndication.com

  # DNS servers to use for resolving allowed domains
  # These are only used when a domain is in the allowlist
  dns_servers:
    - 8.8.8.8
    - 8.8.4.4

  # Enable DNS query logging for debugging
  # When true, all DNS queries are logged to /tmp/kapsis-dns.log
  log_dns_queries: false

  # DNS IP Pinning Configuration
  #
  # Resolves allowed domains on the trusted HOST before container launch and
  # pins IPs inside the container to prevent DNS manipulation attacks.
  #
  # Attack vectors mitigated:
  #   1. Agent kills dnsmasq, rewrites /etc/resolv.conf to bypass filtering
  #   2. Upstream DNS poisoning returns malicious IPs for allowed domains
  #   3. Agent modifies /etc/hosts after dnsmasq is killed
  #
  # Limitations:
  #   - Wildcard domains (*.github.com) cannot be pre-resolved
  #   - CDN domains with rotating IPs may cause stale pinning
  #   - Requires network on host during container launch
  dns_pinning:
    # Enable DNS IP pinning (default: true for filtered mode)
    enabled: true

    # Fallback behavior when resolution fails:
    #   dynamic - Continue with dynamic upstream DNS (degrades to current behavior)
    #   abort   - Fail container launch if resolution fails
    fallback: dynamic

    # Timeout for DNS resolution in seconds
    resolve_timeout: 5

    # Protect /etc/resolv.conf and /etc/hosts from modification inside container
    # Sets chmod 444 after DNS setup (agent runs as non-root, cannot override)
    protect_dns_files: true

  # Allowed ports (documented for reference)
  # Note: Port filtering is NOT enforced - only DNS filtering
  # These are the typical ports that allowed services use
  allowed_ports:
    - 22    # SSH (git)
    - 80    # HTTP
    - 443   # HTTPS
    - 9418  # Git protocol
