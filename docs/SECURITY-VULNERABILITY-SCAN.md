# Kapsis Security Vulnerability Scan Report

**Date:** 2025-12-26
**Scope:** Comprehensive security audit of the Kapsis codebase
**Status:** Complete

---

## Executive Summary

This document presents the findings from a comprehensive security vulnerability scan of the Kapsis codebase. The analysis covered container isolation, shell script security, secrets handling, file permissions, network security, git workflow security, and CI/CD pipeline security.

**Overall Security Posture:** GOOD with areas for improvement

| Severity | Count | Description |
|----------|-------|-------------|
| CRITICAL | 5 | Immediate attention required |
| HIGH | 8 | Fix before production deployment |
| MEDIUM | 12 | Address in next development cycle |
| LOW | 6 | Recommended improvements |

---

## Table of Contents

1. [Critical Vulnerabilities](#1-critical-vulnerabilities)
2. [High Severity Issues](#2-high-severity-issues)
3. [Medium Severity Issues](#3-medium-severity-issues)
4. [Low Severity Issues](#4-low-severity-issues)
5. [Positive Security Findings](#5-positive-security-findings)
6. [Missing Security Features](#6-missing-security-features)
7. [Remediation Roadmap](#7-remediation-roadmap)

---

## 1. Critical Vulnerabilities

### 1.1 Supply Chain: Unverified Binary Downloads

**Files:**
- `Containerfile:54-55`
- `Containerfile:61`
- `Containerfile:86`

**Issue:** Critical binaries downloaded without integrity verification.

```dockerfile
# yq - No checksum verification
RUN wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64

# SDKMAN - Classic curl|bash anti-pattern
RUN curl -s "https://get.sdkman.io?rcupdate=false" | bash

# NVM - Piped to bash
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
```

**Risk:** Supply chain compromise if GitHub/SDKMAN/NVM servers are compromised. The `/latest/` redirect for yq is especially dangerous as it could facilitate downgrade attacks.

**Remediation:**
1. Pin yq to specific version with SHA256 verification
2. Download SDKMAN/NVM scripts, verify hash, then execute
3. Consider vendoring installation scripts

---

### 1.2 Shell Injection via eval

**File:** `scripts/launch-agent.sh:707`

```bash
account=$(eval echo "$account" 2>/dev/null || echo "$account")
```

**Issue:** The `eval` command processes `$account` from YAML configuration. Malicious config could execute arbitrary commands.

**Attack Scenario:**
```yaml
keychain:
  API_KEY:
    account: "$(rm -rf /)"  # Would execute
```

**Remediation:** Use parameter expansion instead of eval:
```bash
account="${account//\$USER/$USER}"
account="${account//\${USER}/$USER}"
```

---

### 1.3 Credential File Race Condition

**File:** `scripts/entrypoint.sh:98-99`

```bash
echo "$value" > "$file_path"
chmod "${file_mode:-0600}" "$file_path"
```

**Issue:** Credentials written with default umask, then chmod'd. Window exists for other processes to read credentials.

**Remediation:**
```bash
umask 0077
echo "$value" > "$file_path"
# Or use: install -m 0600 /dev/stdin "$file_path" <<< "$value"
```

---

### 1.4 GitHub Actions: Unpinned Actions Using @master/@main

**File:** `.github/workflows/security.yml`

```yaml
# Lines 67, 83 - Using @master tag
- uses: aquasecurity/trivy-action@master

# Line 100 - Using @main tag
- uses: trufflesecurity/trufflehog@main
```

**Issue:** Actions pinned to mutable branch tags can be compromised by attackers who gain access to the action repository.

**Remediation:** Pin to full SHA256 commit hashes:
```yaml
- uses: aquasecurity/trivy-action@a20de5420d57c4102486cdd9578b45609c99d7eb
```

---

### 1.5 Unquoted Variable in Release Pipeline

**File:** `.github/workflows/release.yml:110`

```bash
podman save kapsis:$VERSION | gzip > kapsis-$VERSION.tar.gz
```

**Issue:** `$VERSION` not quoted. If version contains spaces or special characters, command injection is possible.

**Remediation:**
```bash
podman save "kapsis:$VERSION" | gzip > "kapsis-$VERSION.tar.gz"
```

---

## 2. High Severity Issues

### 2.1 World-Writable Directories in Test Framework

**File:** `tests/lib/test-framework.sh:587,889,945`

```bash
chmod 777 "$CONTAINER_TEST_UPPER" "$CONTAINER_TEST_SANDBOX/work"
chmod 777 "$test_dir/lower" "$test_dir/upper" "$test_dir/work"
chmod 777 "$sandbox/upper" "$sandbox/work"
```

**Risk:** World-writable directories in test environment could allow privilege escalation.

**Remediation:** Use `chmod 755` or `750` unless absolutely necessary.

---

### 2.2 Overly Permissive Worktree Permissions

**File:** `scripts/worktree-manager.sh:185`

```bash
chmod -R a+rwX "$worktree_path" 2>/dev/null || true
```

**Risk:** All files become world-readable/writable, including configuration and source code.

**Remediation:** Use proper UID/GID mapping via Podman's `--userns=keep-id` instead of world permissions.

---

### 2.3 SELinux/AppArmor Disabled

**File:** `scripts/launch-agent.sh:843`

```bash
"--security-opt" "label=disable"
```

**Risk:** Removes mandatory access control layer. Container escapes become more severe.

**Remediation:** Investigate SELinux/AppArmor compatibility with fuse-overlayfs; consider custom profiles.

---

### 2.4 Log Files Without Explicit Permissions

**File:** `scripts/lib/logging.sh:174`

```bash
touch "$base_path"
# No chmod - inherits umask
```

**Risk:** Log files may contain sensitive debug information and be world-readable.

**Remediation:** Add `chmod 0600 "$base_path"` after file creation.

---

### 2.5 eval in Logging Framework

**File:** `scripts/lib/logging.sh:355`

```bash
log_cmd() {
    local cmd="$*"
    eval "$cmd"
}
```

**Risk:** If `log_cmd` is called with untrusted input, arbitrary commands execute.

**Remediation:** Use arrays for command execution instead of eval.

---

### 2.6 Unsafe xargs Without Null Termination

**Files:**
- `scripts/launch-agent.sh:796-797`
- `tests/test-cleanup-sandbox.sh:179`

```bash
key=$(echo "$line" | cut -d'=' -f1 | xargs)
echo "$orphans" | xargs podman volume rm
```

**Risk:** Special characters in input could be interpreted as argument separators.

**Remediation:** Use `xargs -0` with `tr '\n' '\0'` for null-terminated input.

---

### 2.7 Sed Pattern Injection

**File:** `scripts/launch-agent.sh:1066`

```bash
find "$UPPER_DIR" -type f 2>/dev/null | sed "s|^${UPPER_DIR}/|  |"
```

**Risk:** If `$UPPER_DIR` contains sed metacharacters (`. * [ ] ^ $`), pattern matching fails or behaves unexpectedly.

**Remediation:** Escape special characters or use alternative approach.

---

### 2.8 Missing CI Workflow Permissions

**File:** `.github/workflows/ci.yml`

**Issue:** No explicit `permissions:` block. Defaults to full read-write access.

**Remediation:** Add minimal permissions:
```yaml
permissions:
  contents: read
  actions: read
```

---

## 3. Medium Severity Issues

### 3.1 No Default Network Isolation

**Issue:** Containers have unrestricted network access. SECURITY.md recommends `--network=none` but this is not implemented.

**File:** `scripts/launch-agent.sh:833-843` - No `--network` flag

**Remediation:** Add network configuration option to agent configs; consider default `--network=none` with opt-in.

---

### 3.2 No Seccomp Profile

**Issue:** No syscall filtering configured. Containers can make all syscalls.

**Remediation:** Create custom seccomp profile for agent containers.

---

### 3.3 ~/.ssh Mounting Allowed in Examples

**File:** `configs/claude.yaml:12`

```yaml
filesystem:
  include:
    - ~/.ssh  # SENSITIVE
```

**Issue:** Default config example includes sensitive SSH directory, contrary to SECURITY.md guidance.

**Remediation:** Remove from examples; add documentation warning.

---

### 3.4 Base Image Not Pinned to Digest

**File:** `Containerfile:4`

```dockerfile
ARG BASE_IMAGE=ubuntu:24.04
```

**Issue:** Tag is floating; rebuilds may produce different binaries.

**Remediation:** Pin to digest: `ubuntu:24.04@sha256:<hash>`

---

### 3.5 Status Files Without Permissions

**File:** `scripts/lib/status.sh:340-341`

**Issue:** JSON status files created without explicit chmod.

**Remediation:** Add `chmod 0600` after file creation.

---

### 3.6 Directory Creation Without Permissions

**Files:** Multiple locations

**Issue:** `mkdir -p` calls without explicit chmod.

**Remediation:** Set `umask 0077` before mkdir or use `install -d -m 0700`.

---

### 3.7 Git Config Files Without Permissions

**File:** `scripts/worktree-manager.sh:319,336,344`

**Issue:** Git config written via heredoc without chmod.

**Remediation:** Add `chmod 0600 "$config_path"` after write.

---

### 3.8 Branch Protection Not Automatic

**Issue:** GitHub branch protection available via setup script but not enforced.

**File:** `scripts/setup-github-protection.sh`

**Remediation:** Document as required step; consider automatic validation.

---

### 3.9 No Commit Signing

**Issue:** Agent commits are not GPG/SSH signed.

**Remediation:** Add optional commit signing feature.

---

### 3.10 RELEASE_TOKEN Scope Unknown

**File:** `.github/workflows/auto-release.yml:121`

**Issue:** Custom PAT token used without documented scope restrictions.

**Remediation:** Document required scopes; verify minimal permissions.

---

### 3.11 Temp File Cleanup Not Guaranteed

**File:** `scripts/launch-agent.sh:850-852`

```bash
INLINE_SPEC_FILE=$(mktemp)
echo "$TASK_INLINE" > "$INLINE_SPEC_FILE"
```

**Issue:** No trap handler for cleanup on error paths.

**Remediation:** Add `trap 'rm -f "$INLINE_SPEC_FILE"' EXIT`.

---

### 3.12 eval in Test Framework

**File:** `tests/lib/test-framework.sh:280,293,308,323,544`

**Issue:** Test assertions execute commands via eval.

**Remediation:** Ensure test inputs are validated; consider safer alternatives.

---

## 4. Low Severity Issues

### 4.1 mktemp Pattern Constraints

**File:** `quick-start.sh:111`

```bash
SPEC_FILE=$(mktemp /tmp/kapsis-spec-XXXXXX.md)
```

**Issue:** Fixed suffix slightly reduces entropy.

**Remediation:** Use standard mktemp pattern.

---

### 4.2 No Network Tests

**Issue:** Network isolation is documented but not tested.

**Remediation:** Add network isolation tests to test suite.

---

### 4.3 Log Directory Permissions Not Validated

**File:** `scripts/lib/logging.sh:104-107`

**Issue:** Log directory created without explicit permissions.

**Remediation:** Add `chmod 0700 "$KAPSIS_LOG_DIR"`.

---

### 4.4 Documentation Gap: Git URL Safety

**Issue:** Not explicitly documented that remote URLs come from `.git/config`.

**Remediation:** Add documentation on URL handling.

---

### 4.5 No Worktree State Validation

**Issue:** Documented that worktree should be clean, but not enforced in code.

**Remediation:** Add pre-launch check for uncommitted changes.

---

### 4.6 Symlink Objects Directory Documentation

**File:** `scripts/worktree-manager.sh:277-281`

**Issue:** Symlink path is safe but security model not documented in code.

**Remediation:** Add comments explaining security model.

---

## 5. Positive Security Findings

The following security measures are well-implemented:

| Feature | Status | Evidence |
|---------|--------|----------|
| Rootless Podman | GOOD | `--userns=keep-id` in launch-agent.sh |
| Non-root container user | GOOD | USER developer in Containerfile |
| Empty git hooks directory | GOOD | worktree-manager.sh sanitization |
| FSCK object validation | GOOD | `fsckObjects = true` in git config |
| Read-only git objects mount | GOOD | `:ro` mount flags |
| Post-push verification | GOOD | post-container-git.sh verification |
| Keychain integration | GOOD | macOS/Linux secret store support |
| Credentials masking in logs | GOOD | `***MASKED***` pattern |
| Environment variable unsetting | GOOD | unset after file injection |
| Per-agent Maven repositories | GOOD | SNAPSHOT blocking |
| CODEOWNERS configured | GOOD | All critical paths covered |
| Dependabot enabled | GOOD | Weekly updates for actions/images |
| Secret scanning (TruffleHog) | GOOD | Runs on push and PR |
| ShellCheck in CI | GOOD | SARIF upload to security tab |
| Trivy container scanning | GOOD | CRITICAL/HIGH vulnerabilities reported |
| No hardcoded secrets | GOOD | Only test data, no real keys |
| HTTPS for all downloads | GOOD | No HTTP fallbacks |

---

## 6. Missing Security Features

### 6.1 Not Implemented

| Feature | Impact | Effort |
|---------|--------|--------|
| Network isolation (`--network=none`) | HIGH | LOW |
| Seccomp profiles | MEDIUM | MEDIUM |
| Commit signing | MEDIUM | MEDIUM |
| Input validation for version | MEDIUM | LOW |
| Checksum verification for downloads | HIGH | MEDIUM |

### 6.2 Partially Implemented

| Feature | Current State | Gap |
|---------|--------------|-----|
| Branch protection | Script available | Not enforced |
| SELinux/AppArmor | Disabled | Compatibility investigation needed |
| File permissions | Inconsistent | Standardize with umask |

### 6.3 Documentation Gaps

- Network security beyond container boundaries
- RELEASE_TOKEN scope requirements
- Git URL handling model
- Worktree state requirements

---

## 7. Remediation Roadmap

### Phase 1: Critical (Immediate - 1 week)

1. **Fix supply chain vulnerabilities**
   - Pin yq to specific version with SHA256
   - Verify SDKMAN/NVM scripts before execution
   - Replace `@master`/`@main` action tags with SHA

2. **Fix shell injection**
   - Replace eval with parameter expansion in launch-agent.sh:707
   - Quote all variables in release.yml

3. **Fix credential race condition**
   - Set umask before credential file creation

### Phase 2: High (2-4 weeks)

4. **Fix file permissions**
   - Standardize chmod after file creation
   - Remove world-writable permissions from tests
   - Replace `chmod -R a+rwX` with proper UID mapping

5. **Fix CI/CD security**
   - Add permissions block to ci.yml
   - Pin all action versions to SHA
   - Validate version input format

6. **Fix logging security**
   - Add chmod to log file creation
   - Replace eval in log_cmd with arrays

### Phase 3: Medium (1-2 months)

7. **Implement network isolation**
   - Add `--network` config option
   - Default to `--network=none` with opt-in

8. **Implement seccomp profiles**
   - Create minimal seccomp profile
   - Test with agent workloads

9. **Improve documentation**
   - Document all security requirements
   - Remove ~/.ssh from example configs
   - Add branch protection setup guide

### Phase 4: Low (Ongoing)

10. **Continuous improvement**
    - Add network isolation tests
    - Implement commit signing
    - Investigate SELinux/AppArmor compatibility
    - Regular dependency updates

---

## Conclusion

Kapsis demonstrates a strong security architecture with multiple isolation layers. The primary concerns are:

1. **Supply chain security** - Unverified binary downloads in the build process
2. **Code injection** - eval usage with config data
3. **File permissions** - Inconsistent permission handling

These are addressable issues that don't undermine the core security model. The combination of rootless containers, sanitized git, read-only mounts, and push verification provides excellent defense-in-depth for AI agent sandboxing.

---

*Report generated by automated security scan. Manual review recommended for all findings.*
