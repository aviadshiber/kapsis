name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check which files changed to determine if tests should run
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      scripts: ${{ steps.filter.outputs.scripts }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            scripts:
              - 'scripts/**'
              - 'tests/**'
              - 'configs/**'
              - 'Containerfile'
              - 'setup.sh'
              - '.github/workflows/ci.yml'

  lint:
    name: ShellCheck Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.scripts == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Find shell scripts
        id: find-scripts
        run: |
          # Find all shell scripts (by extension and shebang)
          scripts=$(find . -type f \( -name "*.sh" -o -name "*.bash" \) ! -path "./.git/*" | sort)
          echo "Found shell scripts:"
          echo "$scripts"
          echo "scripts<<EOF" >> $GITHUB_OUTPUT
          echo "$scripts" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run ShellCheck
        run: |
          # Run ShellCheck on all shell scripts
          # -S warning: Only fail on warning level and above (not info/style)
          # Other config from .shellcheckrc
          failed=0

          while IFS= read -r script; do
            if [[ -n "$script" ]]; then
              echo "::group::Checking $script"
              if ! shellcheck -S warning "$script"; then
                failed=1
              fi
              echo "::endgroup::"
            fi
          done <<< "${{ steps.find-scripts.outputs.scripts }}"

          if [[ $failed -eq 1 ]]; then
            echo "::error::ShellCheck found issues in one or more scripts"
            exit 1
          fi
          echo "All scripts passed ShellCheck!"

  quick-tests:
    name: Quick Tests
    runs-on: ubuntu-latest
    needs: [changes, lint]
    if: needs.changes.outputs.scripts == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Configure git for tests
        run: |
          # Configure git identity for test commits
          git config --global user.email "ci@kapsis.test"
          git config --global user.name "Kapsis CI"
          # Disable commit signing in CI environment
          git config --global commit.gpgsign false
          git config --global tag.gpgsign false

      - name: Run quick tests
        run: |
          chmod +x ./tests/run-all-tests.sh
          chmod +x ./tests/*.sh
          chmod +x ./tests/lib/*.sh 2>/dev/null || true
          chmod +x ./scripts/*.sh
          chmod +x ./scripts/lib/*.sh 2>/dev/null || true

          # Run quick tests (no container required)
          ./tests/run-all-tests.sh --quick
        env:
          KAPSIS_TEST_QUIET: "0"

  container-tests:
    name: Container Tests
    runs-on: ubuntu-latest
    needs: [changes, quick-tests]
    if: needs.changes.outputs.scripts == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure git for tests
        run: |
          git config --global user.email "ci@kapsis.test"
          git config --global user.name "Kapsis CI"
          git config --global commit.gpgsign false
          git config --global tag.gpgsign false

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman fuse-overlayfs slirp4netns jq
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Configure Podman for rootless
        run: |
          # Set up rootless Podman
          mkdir -p ~/.config/containers
          echo '[storage]' > ~/.config/containers/storage.conf
          echo 'driver = "overlay"' >> ~/.config/containers/storage.conf

          # Verify Podman installation
          podman --version
          podman info --debug 2>&1 | head -20 || true

      - name: Build Kapsis container image
        run: |
          chmod +x ./scripts/build-image.sh
          ./scripts/build-image.sh --name kapsis-test --tag ci
        timeout-minutes: 30

      - name: Run container tests
        run: |
          chmod +x ./tests/run-all-tests.sh
          chmod +x ./tests/*.sh
          chmod +x ./tests/lib/*.sh 2>/dev/null || true
          chmod +x ./scripts/*.sh
          chmod +x ./scripts/lib/*.sh 2>/dev/null || true

          # Run all tests (includes container tests)
          ./tests/run-all-tests.sh
        timeout-minutes: 45
        env:
          KAPSIS_TEST_QUIET: "0"
          KAPSIS_IMAGE: "kapsis-test:ci"

  # Summary job that all required checks depend on
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [changes, lint, quick-tests, container-tests]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          # If no script changes, all tests are skipped - that's OK
          if [[ "${{ needs.changes.outputs.scripts }}" != "true" ]]; then
            echo "No script changes detected - CI tests skipped"
            echo "Files changed: docs, assets, or other non-code files"
            exit 0
          fi

          # Script changes detected - all tests must pass
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Lint job failed"
            exit 1
          fi
          if [[ "${{ needs.quick-tests.result }}" != "success" ]]; then
            echo "Quick tests job failed"
            exit 1
          fi
          if [[ "${{ needs.container-tests.result }}" != "success" ]]; then
            echo "Container tests job failed"
            exit 1
          fi

          echo "All required CI checks passed!"
